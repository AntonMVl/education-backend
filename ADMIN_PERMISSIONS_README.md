# Система прав доступа для администраторов

## Обзор

Система реализует Role-Based Access Control (RBAC) с детальными правами для администраторов. Суперадминистраторы имеют полный доступ, а обычные администраторы получают права в зависимости от назначенных им разрешений.

## Роли пользователей

### 1. Суперадминистратор (superadmin)

- **Полный доступ** ко всем функциям системы
- Может создавать, редактировать и удалять любых пользователей
- Может назначать права другим администраторам
- **Защищен** от изменений со стороны обычных администраторов

### 2. Администратор (admin)

- **Ограниченный доступ** в зависимости от назначенных прав
- По умолчанию может управлять только обычными пользователями
- Для управления другими администраторами требуется специальное право

### 3. Пользователь (user)

- Обычные пользователи системы
- Не имеют прав администратора

## Права доступа

### Базовые права для управления пользователями

- `create_users` - Создание пользователей
- `edit_users` - Редактирование пользователей
- `delete_users` - Удаление пользователей

### Права для управления администраторами

- `manage_admins` - Создание, редактирование и удаление администраторов
- `manage_admin_permissions` - Управление правами других администраторов

### Права для управления контентом

- `manage_courses` - Управление курсами
- `manage_lectures` - Управление лекциями
- `manage_tests` - Управление тестами
- `review_exams` - Проверка экзаменов

## Логика предоставления прав

### Автоматическое предоставление прав

При предоставлении права `manage_admins` автоматически предоставляются права:

- `create_users`
- `edit_users`
- `delete_users`

### Ограничения для администраторов

1. **Администраторы не могут:**
   - Создавать, редактировать или удалять суперадминистраторов
   - Изменять свои собственные права
   - Назначать роль суперадминистратора

2. **Администраторы могут:**
   - Управлять обычными пользователями (если есть соответствующие права)
   - Управлять другими администраторами (если есть право `manage_admins`)
   - Назначать права другим администраторам (если есть право `manage_admin_permissions`)

## Настройка базы данных

### 1. Добавление поля permissions

```sql
-- Выполните скрипт add-permissions-column.sql
```

### 2. Предоставление прав администратору

```sql
-- Дать администратору право на управление другими администраторами
UPDATE "user"
SET "permissions" = array_append("permissions", 'manage_admins')
WHERE "id" = [ID_АДМИНИСТРАТОРА];

-- Дать право на управление правами других администраторов
UPDATE "user"
SET "permissions" = array_append("permissions", 'manage_admin_permissions')
WHERE "id" = [ID_АДМИНИСТРАТОРА];
```

### 3. Проверка текущих прав

```sql
-- Посмотреть права конкретного пользователя
SELECT "id", "firstName", "lastName", "role", "permissions"
FROM "user"
WHERE "id" = [ID_ПОЛЬЗОВАТЕЛЯ];
```

## Использование в админ-панели

### Вкладка "Пользователи"

- Администраторы видят только пользователей с ролями `user` и `admin`
- Кнопки "Создать", "Редактировать", "Удалить" отображаются в зависимости от прав
- При создании пользователя доступные роли зависят от прав:
  - Без права `manage_admins`: только роль `user`
  - С правом `manage_admins`: роли `user` и `admin`

### Вкладка "Администраторы"

- Доступна только суперадминистраторам и администраторам с правом `manage_admins`
- Позволяет управлять правами других администраторов
- Администраторы не могут изменять свои собственные права

## API Endpoints

### Управление пользователями

- `GET /admin/users` - Получение списка пользователей
- `POST /admin/users` - Создание пользователя
- `PATCH /admin/users/:id` - Обновление пользователя
- `DELETE /admin/users/:id` - Удаление пользователя

### Управление правами администраторов

- `GET /admin/admins` - Получение списка администраторов
- `GET /admin/admins/:id/permissions` - Получение прав администратора
- `PATCH /admin/admins/:id/permissions` - Обновление прав администратора

### Проверка прав

- `GET /admin/permissions/check/:permission` - Проверка конкретного права
- `GET /admin/permissions/my` - Получение своих прав

## Безопасность

### Защита суперадминистраторов

- Администраторы не могут изменять суперадминистраторов
- Суперадминистраторы не могут быть удалены
- Только суперадминистраторы могут назначать роль суперадминистратора

### Защита от самоизменения

- Администраторы не могут изменять свои собственные права
- Пользователи не могут удалять свои аккаунты через админ-панель

### Валидация прав

- Все операции проверяют наличие соответствующих прав
- При отсутствии прав возвращается ошибка 403 Forbidden
- Логирование всех операций с правами доступа

## Примеры использования

### Создание администратора с правами

1. Суперадминистратор создает нового администратора
2. Назначает ему права через вкладку "Администраторы"
3. Новый администратор получает доступ к соответствующим функциям

### Делегирование управления

1. Суперадминистратор предоставляет администратору право `manage_admins`
2. Администратор автоматически получает права на управление пользователями
3. Администратор может создавать и управлять другими администраторами
4. Администратор не может изменять свои собственные права

## Troubleshooting

### Проблема: Администратор не видит кнопки управления

**Решение:** Проверьте наличие соответствующих прав в базе данных

### Проблема: Ошибка "У вас нет прав на создание администраторов"

**Решение:** Убедитесь, что у пользователя есть право `manage_admins`

### Проблема: Не удается изменить права администратора

**Решение:** Проверьте, что текущий пользователь имеет право `manage_admin_permissions`
