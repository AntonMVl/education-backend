# Исправление проблемы с паролями

## Проблема

В логах бэкенда появляется ошибка:

```
pchstr must contain a $ as first char
TypeError: pchstr must contain a $ as first char
```

Эта ошибка означает, что пароли в базе данных хранятся в неправильном формате для библиотеки argon2.

## Причина

Пароли в базе данных не хешированы с помощью argon2 или хешированы неправильно. Библиотека argon2 ожидает, что хеши начинаются с символа `$`.

## Решение

### 1. Выполните SQL миграцию

Запустите файл `src/database/migrate-passwords.sql` в вашей базе данных. Этот скрипт:

- Очистит все неправильно хешированные пароли
- Установит правильные хеши argon2 для всех пользователей

### 2. Тестовые пароли после миграции

- **admin** (superadmin): `admin123`
- **admin2** (admin): `admin123`
- **Все остальные пользователи**: `user123`

### 3. Проверка

После выполнения миграции проверьте, что:

- Все пароли начинаются с `$argon2id$`
- Аутентификация работает корректно
- Смена паролей работает

### 4. Исправления в коде

Внесены следующие исправления:

- ✅ Добавлено хеширование паролей в `admin.service.ts` (метод `updateUser`)
- ✅ Добавлен эндпоинт для сброса паролей в `user.controller.ts`
- ✅ Добавлен метод `resetPassword` в `user.service.ts`

## Временное решение (если миграция не помогает)

Если проблема сохраняется, можно временно использовать простые пароли:

1. Выполните `src/database/fix-passwords-simple.sql`
2. Временно измените логику в `auth.service.ts`:
   ```typescript
   const passwordIsMatch = user.password === password;
   ```
3. Временно измените логику в `user.service.ts`:
   ```typescript
   // if (updateUserDto.password) {
   //   updateUserDto.password = await argon2.hash(updateUserDto.password);
   // }
   ```

**ВНИМАНИЕ**: Временное решение небезопасно и должно быть исправлено как можно скорее!

## Долгосрочное решение

1. ✅ Убедитесь, что все новые пользователи создаются с правильно хешированными паролями
2. ✅ Реализуйте миграцию для существующих пользователей
3. ✅ Добавьте валидацию формата паролей при создании/обновлении
4. Рассмотрите возможность использования bcrypt вместо argon2, если проблемы продолжаются

## API эндпоинты для работы с паролями

### Обновление пользователя (включая пароль)

```
PATCH /admin/users/:id
Authorization: Bearer <token>
Content-Type: application/json

{
  "firstName": "Имя",
  "lastName": "Фамилия",
  "password": "новый_пароль"
}
```

### Сброс пароля пользователя

```
POST /user/reset-password/:id
Authorization: Bearer <token>
```

### Обновление профиля (собственного)

```
PATCH /auth/profile
Authorization: Bearer <token>
Content-Type: application/json

{
  "firstName": "Имя",
  "lastName": "Фамилия",
  "password": "новый_пароль"
}
```

## Проверка работоспособности

1. Запустите бэкенд
2. Выполните SQL миграцию
3. Попробуйте войти с тестовыми паролями
4. Попробуйте сменить пароль пользователя через админку
5. Проверьте, что новый пароль работает при входе
